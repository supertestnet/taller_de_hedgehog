<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <title>Hedgehog Workshop</title>
        <script src="https://supertestnet.github.io/bankify/super_nostr.js"></script>
        <script src="https://unpkg.com/@dashincubator/ripemd160/ripemd160.js"></script>
        <script src="https://supertestnet.github.io/testnet_generator/chain_client.js"></script>
        <script src="https://unpkg.com/@cmdcode/tapscript@1.4.0"></script>
        <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
        <script src="https://supertestnet.github.io/taller_de_hedgehog/hedgehog.js"></script>
        <script src="https://supertestnet.github.io/taller_de_hedgehog/hedgehog_workshop.js"></script>
<!--
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/super_nostr.js"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/ripemd160.js"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/chain_client.js"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/tapscript@1.5.3"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/testnet_generator/noble-secp256k1@1.2.14"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/hedgehog_workshop/hedgehog.js"></script>
        <script src="file:///home/supertestnet/bitcoin_projects/hedgehog_workshop/hedgehog_workshop.js"></script>
-->
        <style>
            * {
                box-sizing: border-box;
                font-size: 1.15rem;
                font-family: Arial, sans-serif;
            }
            html {
                max-width: 800px;
                padding: 3rem 1rem;
                margin: auto;
                line-height: 1.25;
                padding: 0;
            }
            body {
                margin: 3rem 1rem;
                word-wrap: break-word;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
            input {
                line-height: 1.25;
                width: 100%;
                height: 1.8rem;
                font-size: 1.15rem;
                border: 1px solid grey;
            }
            .hidden {
                display: none !important;
            }
            .wallet_page {
                max-width: 25rem;
                margin: auto;
            }
            .bordered {
                border: 1px solid black;
                border-radius: 1rem;
                padding: 1rem;
            }
            .channel {
                margin-top: 1rem;
            }
            .instructions_div {
                padding: 1rem;
                background-color: #cccccc;
            }
            .instructions_div * {
                font-family: monospace;
            }
            @media screen and (max-width: 600px) {
            }
        </style>
        <style>
            .black-bg {
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                background-color: black;
                opacity: .5;
                width: 100vw;
                height: 100vh;
            }
            .modal {
                position: fixed;
                box-sizing: border-box;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                width: 90%;
                max-width: 560px;
                background-color: white;
                border-radius: 1rem;
                padding: 20px;
                color: black;
                text-align: center;
                word-wrap: break-word;
            }
            .modal * {
                color: black;
            }
            .modal input, .modal textarea {
                max-width: 90%;
            }
        </style>
        <script>
            var modalVanish = () => {
                $( ".black-bg" ).classList.add( "hidden" );
                $( ".modal" ).classList.add( "hidden" );
            }
            var showModal = content => {
                $( ".modal" ).innerHTML = `<div class="x_modal" style="position: absolute;right: 1rem;top: 0.5rem;font-size: 2rem; cursor: pointer; color: black;" onclick="modalVanish()">&times;</div>`;
                $( ".modal" ).innerHTML += `<div style="overflow-y: auto; max-height: 80vh; margin-top: 1.5rem;">${content}</div>`;
                $( ".black-bg" ).classList.remove( "hidden" );
                $( ".modal" ).classList.remove( "hidden" );
            }
        </script>
        <script>
            var $ = document.querySelector.bind( document );
            var $$ = document.querySelectorAll.bind( document );
            var url_params = new URLSearchParams( window.location.search );
            var url_keys = url_params.keys();
            var $_GET = {}
            for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
            var hash_arr = window.location.href.substring( window.location.href.indexOf( "#" ) ).split( "#" );
            hash_arr.splice( 0, 1 );
            var $_HASH = {}
            hash_arr.forEach( item => {
                var vals = item.split( "=" );
                $_HASH[ vals[ 0 ] ] = vals[ 1 ];
            });
        </script>
    </head>
    <body>
        <div class="hideable_page home_page">
            <h1>Hedgehog Workshop</h1>
            <p style="font-weight:bold;">Network string (share this with others):</p>
            <p class="network_string">loading...</p>
            <p><button class="genblock hidden">Generate block</button></p>
        </div>
        <div class="hideable_page loading_page hidden">
            <p>loading...</p>
        </div>
        <div class="hideable_page wallet_page hidden">
            <h1>Wallet</h1>
            <hr>
            <p style="font-weight: bold; text-align: center;">Your address</p>
            <p style="text-align: center;" class="btc_address"></p>
            <hr>
            <p>Confirmed L1 balance: <span class="confirmed_balance">0</span> sats</p>
            <p>Unconfirmed L1 balance: <span class="unconfirmed_balance">0</span> sats</p>
            <p>Confirmed L2 balance: <span class="confirmed_hedgehog_balance">0</span> sats</p>
            <p>Unconfirmed L2 balance: <span class="unconfirmed_hedgehog_balance">0</span> sats</p>
            <hr>
            <p><button class="use_faucet">Use faucet</button> <button class="send_on_L1">Send on L1</button></p>
            <p><button class="send_btn">Send on hedgehog</button> <button class="receive_btn">Receive on hedgehog</button></p>
            <p><button class="manage_channels">Manage channels</button></p>
            <p><button class="share_channel_opening_data">Share channel opening data</button></p>
            <p><button class="view_blockchain">View the blockchain</button></p>
            <div class="instructions_div">
                <p>Instructions:</p>
                <div class="instructions">
                    <p>To start, the Channel Opener should click the Use Faucet button</p>
                    <p>Then that person should click Manage Channels -> Open Channel and follow the instructions</p>
                    <p>Then the Channel Recipient click Receive on Hedgehog</p>
                </div>
            </div>
        </div>
        <div class="hideable_page manage_channels_page hidden">
            <h2>Manage channels</h2>
            <p><button class="back_btn">Back</button> <button class="open_channel">Open channel</button></p>
            <p style="font-weight: bold;">List of channels</p>
            <div class="channels_list"></div>
        </div>
        <script>
            hedgehog_workshop.relays = [ "wss://no.str.cr" ];
            // hedgehog_workshop.relays = [ "ws://127.0.0.1:6969" ];
            var showPage = page => {
                $$( '.hideable_page' ).forEach( page => page.classList.add( "hidden" ) );
                $( `.${page}` ).classList.remove( "hidden" );
            }
            $( `.use_faucet` ).onclick = async () => {
                if ( !hedgehog_workshop.faucet_usable ) return alert( 'faucet may only be used once' );
                await hedgehog_workshop.useFaucet();
                var { confirmed_balance, unconfirmed_balance } = await hedgehog_workshop.getBalances();
                $( '.confirmed_balance' ).innerText = confirmed_balance.toLocaleString();
                $( '.unconfirmed_balance' ).innerText = unconfirmed_balance.toLocaleString();
            }
            $( '.send_on_L1' ).onclick = async () => {
                var address = prompt( `enter a btc address you want to send to` );
                if ( !address ) return;
                var amnt = Number( prompt( `enter an amount of sats you want to send there` ) );
                if ( !amnt ) return;
                if ( amnt < 330 ) return alert( 'try again, the minimum amount is 330 sats' );
                var sats_per_byte = 1;
                var utxos = JSON.parse( JSON.stringify( hedgehog_workshop.utxos ) );
                utxos.forEach( ( utxo, index ) => {
                    utxos[ index ][ "address" ] = hedgehog_workshop.btc_address;
                    utxos[ index ][ "privkey" ] = hedgehog_workshop.btc_privkey;
                });
                var change_address = hedgehog_workshop.btc_address;
                var txhex = await hedgehog_workshop.spendCoins( address, amnt, sats_per_byte, utxos, change_address );
                chain_client.commander( hedgehog_workshop.network_string.split( "," ), "broadcast", txhex );
            }
            $( '.send_btn' ).onclick = () => {
                if ( !Object.keys( hedgehog.state ).length ) return alert( `open a channel first using the Manage Channels button` );
                    // <select name="cars" id="cars" form="carform">
                var html = `
                    <p>Select a channel</p>
                    <select class="send_form">
                `;
                var i; for ( i=0; i<Object.keys( hedgehog.state ).length; i++ ) {
                    var chan_id = Object.keys( hedgehog.state )[ i ];
                    var channel_label = hedgehog.state[ chan_id ].label;
                    var channel_balance = hedgehog.state[ chan_id ].alices_privkey ? hedgehog.state[ chan_id ].balances[ 0 ] || 0 : hedgehog.state[ chan_id ].balances[ 1 ] || 0;
                    var html = html + `
                        <option value="${chan_id}">${channel_label} | ${channel_balance} sats</option>
                    `;
                }
                html = html + `</select>
                    <p>Enter an amount of sats to send</p>
                    <p><input class="amnt_to_send" type="number" min="1" value="1" step="1" max="${channel_balance}"></p>
                    <p><button class="submit_send">Submit</button></p>
                `;
                showModal( html );
                $( '.amnt_to_send' ).focus();
                $( '.amnt_to_send' ).select();
                $( '.amnt_to_send' ).addEventListener( "keydown", e => {
                    if ( e.key === "Enter" ) $( '.submit_send' ).click();
                });
                $( '.submit_send' ).onclick = async () => {
                    var chan_id = $( '.send_form' ).value;
                    var amnt = Number( $( '.amnt_to_send' ).value );
                    $( '.instructions' ).innerHTML = `
                        <p>Send this data to your recipient and have them click the "Receive on hedgehog" button:</p>
                        <p>${JSON.stringify( hedgehog.send( chan_id, amnt ) )}</p>
                    `;
                    $( '.x_modal' ).click();
                    var auto = false;
                    stateLoop( auto );
                }
            }
            $( '.receive_btn' ).onclick = async () => {
                var all_good = await hedgehog.receive();
                var auto = false;
                stateLoop( auto );
                $( '.instructions' ).innerHTML = `
                    <p>Now that you've received money, you can also send it by clicking the Send on Hedgehog button</p>
                `;
            }
            $( '.manage_channels' ).onclick = () => showPage( 'manage_channels_page' );
            $( '.share_channel_opening_data' ).onclick = () => {
                var channel_opening_data = hedgehog_workshop.getChannelOpeningData();
                $( '.instructions' ).innerHTML = `
                    <p>Share the following channel opening data with someone who wants to open a channel to you:</p>
                    <p>${JSON.stringify( channel_opening_data )}</p>
                `;
            }
            $( '.open_channel' ).onclick = async () => {
                var channel_opening_data = JSON.parse( prompt( `Enter your counterparty's channel opening data` ) );
                if ( !channel_opening_data ) return;
                var push_all_funds_to_counterparty = true;
                var alices_address = channel_opening_data[ 2 ];
                var bobs_address = hedgehog_workshop.btc_address;
                var change_address = hedgehog_workshop.btc_address;
                var balances = await hedgehog_workshop.getBalances();
                var utxos = JSON.parse( JSON.stringify( hedgehog_workshop.utxos ) );
                utxos.forEach( ( utxo, index ) => {
                    utxos[ index ][ "address" ] = hedgehog_workshop.btc_address;
                    utxos[ index ][ "privkey" ] = hedgehog_workshop.btc_privkey;
                });
                var sigs_and_stuff = await hedgehog.openChannel( push_all_funds_to_counterparty, null, channel_opening_data, alices_address, bobs_address, change_address, balances, utxos );
                if ( !sigs_and_stuff ) return;
                var auto = false;
                stateLoop( auto );
                $( '.instructions' ).innerHTML = `
                    <p>Send this data to your recipient and have them click the "Receive on hedgehog" button:</p>
                    <p>${JSON.stringify( sigs_and_stuff )}</p>
                `;
                showPage( 'wallet_page' );
            }
            $$( '.back_btn' ).forEach( btn => btn.onclick = () => showPage( 'wallet_page' ) );
            var stateLoop = async ( auto = true ) => {
                var state_of_channels = await hedgehog_workshop.getStateOfChannels();
                //Show status of active channels
                var div = document.createElement( "div" );
                var unconfirmed_hh_balance = 0;
                var confirmed_hh_balance = 0;
                var channels_to_remove = [];
                
                var i; for ( i=0; i<Object.keys( state_of_channels.channels_to_keep ).length; i++ ) {
                    var chan_id = Object.keys( hedgehog.state )[ i ];
                    var channel_label = hedgehog.state[ chan_id ].label;

                    var inner = document.createElement( "div" );
                    var html = `
                        <div>
                            <p>Label: <span class="channel_label">loading...</span></p>
                            <p>Balance: <span class="channel_balance">0</span> sats</p>
                            <p><button class="close_channel">Close channel</button> <button class="channel_send_btn hidden">Send</button> <button class="channel_receive_btn">Receive</button></p>
                        </div>
                    `;
                    inner.innerHTML = html;
                    inner = inner.firstElementChild;
                    inner.classList.add( `channel` );
                    inner.classList.add( `channel_${chan_id}` );
                    inner.classList.add( `bordered` );
                    inner.setAttribute( "data-chan_id", chan_id );
                    inner.getElementsByClassName( "channel_label" )[ 0 ].innerText = channel_label;
                    var channel_balance = hedgehog.state[ chan_id ].alices_privkey ? hedgehog.state[ chan_id ].balances[ 0 ] || 0 : hedgehog.state[ chan_id ].balances[ 1 ] || 0;
                    inner.getElementsByClassName( "channel_balance" )[ 0 ].innerText = channel_balance.toLocaleString();
                    inner.getElementsByClassName( "close_channel" )[ 0 ].onclick = async () => {
                        var force_close_txs = await hedgehog.closeChannel( chan_id );
                        await chain_client.commander( hedgehog_workshop.network_string.split( "," ), "broadcast", force_close_txs[ 0 ] );
                        var auto = false;
                        stateLoop( auto );
                    }
                    inner.getElementsByClassName( "channel_send_btn" )[ 0 ].onclick = () => {
                        $( '.instructions' ).innerHTML = `
                            <p>Send this data to your recipient and have them click the "Receive on hedgehog" button:</p>
                            <p>${JSON.stringify( hedgehog.send( chan_id ) )}</p>
                        `;
                        var auto = false;
                        stateLoop( auto );
                    }
                    inner.getElementsByClassName( "channel_receive_btn" )[ 0 ].onclick = async () => {
                        var all_good = await hedgehog.receive();
                        var auto = false;
                        stateLoop( auto );
                    }
                    div.append( inner );
                }

                //show status of closing channels
                var i; for ( i=0; i<Object.keys( state_of_channels.closing_channels ).length; i++ ) {
                    var chan_id = Object.keys( hedgehog_workshop.channels_being_closed )[ i ];

                    //prepare variables
                    var channel_label = hedgehog_workshop.channels_being_closed[ chan_id ].label;
                    var { money_coming_to_you, waiting_for } = state_of_channels.closing_channels[ chan_id ];

                    var inner = document.createElement( "div" );
                    var html = `
                        <div>
                            <p>Label: <span class="channel_label">loading...</span></p>
                            <p>Money coming to you: <span class="money_coming_to_you">0</span> sats</p>
                            <p>What you are waiting for: <span class="waiting_for"></span></p>
                        </div>
                    `;
                    inner.innerHTML = html;
                    inner = inner.firstElementChild;
                    inner.classList.add( `channel` );
                    inner.classList.add( `channel_${chan_id}` );
                    inner.classList.add( `bordered` );
                    inner.setAttribute( "data-chan_id", chan_id );
                    inner.getElementsByClassName( "channel_label" )[ 0 ].innerText = channel_label;
                    inner.getElementsByClassName( "money_coming_to_you" )[ 0 ].innerText = money_coming_to_you.toLocaleString();
                    inner.getElementsByClassName( "waiting_for" )[ 0 ].innerHTML = waiting_for;
                    div.append( inner );
                }

                if ( !div.children.length ) {
                    var para = document.createElement( "p" );
                    para.innerText = `[None yet]`;
                    div.append( para );
                }

                //display the info
                $( '.channels_list' ).innerHTML = ``;
                while ( div.children.length ) {
                    var chan_id = div.children[ 0 ].hasAttribute( "data-chan_id" ) ? div.children[ 0 ].getAttribute( "data-chan_id" ) : "";
                    if ( $( `.channel_${chan_id}` ) ) div.splice( 0, 1 );
                    else $( '.channels_list' ).append( div.children[ 0 ] );
                }

                //Update balances
                $( '.confirmed_hedgehog_balance' ).innerText = hedgehog_workshop.confirmed_L2_balance.toLocaleString();
                $( '.unconfirmed_hedgehog_balance' ).innerText = hedgehog_workshop.unconfirmed_L2_balance.toLocaleString();
                var { confirmed_balance, unconfirmed_balance } = await hedgehog_workshop.getBalances();
                hedgehog_workshop.confirmed_L1_balance = confirmed_balance;
                hedgehog_workshop.unconfirmed_L1_balance = unconfirmed_balance;
                $( '.confirmed_balance' ).innerText = confirmed_balance.toLocaleString();
                $( '.unconfirmed_balance' ).innerText = unconfirmed_balance.toLocaleString();
                await chain_client.waitSomeTime( 5_000 );
                if ( auto ) stateLoop();
            }
            if ( $_HASH.admin ) {
                var start = async () => {
                    var relay = prompt( `please enter a nostr relay e.g. ${hedgehog_workshop.relays[ 0 ]}`, hedgehog_workshop.relays[ 0 ] );
                    var [ testnet_privkey, network_string ] = await chain_client.createNetwork( [ relay ] );
                    var testnet_pubkey = network_string.split( "," )[ 0 ];
                    hedgehog_workshop.testnet_privkey = testnet_privkey;
                    hedgehog_workshop.network_string = network_string;
                    chain_client.commander( hedgehog_workshop.network_string.split( "," ), "genblock" );
                    $( '.network_string' ).innerText = hedgehog_workshop.network_string;
                    $( '.genblock' ).classList.remove( "hidden" );
                    $( '.genblock' ).onclick = () => {
                        chain_client.commander( hedgehog_workshop.network_string.split( "," ), "genblock" );
                        hedgehog_workshop.txs_in_mempool = 0;
                    }
                    var listenFunction = async socket => {
                        var subId = super_nostr.bytesToHex( crypto.getRandomValues( new Uint8Array( 8 ) ) );
                        var filter  = {}
                        filter.kinds = [ 40427 ];
                        filter.authors = [ testnet_pubkey ];
                        var subscription = [ "REQ", subId, filter ];
                        socket.send( JSON.stringify( subscription ) );
                    }
                    var handleFunction = async message => {
                        var [ type, subId, event ] = JSON.parse( message.data );
                        if ( !event || event === true ) return;
                        hedgehog_workshop.txs_in_mempool = hedgehog_workshop.txs_in_mempool + 1;
                    }
                    super_nostr.newPermanentConnection( hedgehog_workshop.relays[ 0 ], listenFunction, handleFunction );

                    var loop = async () => {
                        if ( hedgehog_workshop.txs_in_mempool > 4 ) {
                            chain_client.commander( hedgehog_workshop.network_string.split( "," ), "genblock" );
                            hedgehog_workshop.txs_in_mempool = 0;
                        }
                        await chain_client.waitSomeTime( 10 );
                        loop();
                    }
                    loop();
                }
                start();
            } else {
                showPage( 'loading_page' );
                var start = async () => {
                    var network = $_HASH.network ? $_HASH.network : prompt( `enter a network string\n\nto generate one, open a new tab and copy the url, but add #admin=true to it` );
                    var [ _, network_string ] = await chain_client.loadNetwork( null, network );
                    hedgehog_workshop.network_string = network_string;
                    console.log( `I am connected, right?`, !!hedgehog_workshop.network_string );
                    var testnet_pubkey = network_string.split( "," )[ 0 ];
                    var hex_relays = chain_client.textToHex( JSON.stringify( [ network_string.split( "," )[ 1 ] ] ) );
                    $( '.view_blockchain' ).onclick = () => {
                        var url = chain_client.base_url + `#pubkey=${network_string.split( "," )[ 0 ]}#relays=${hex_relays}`;
                        window.open( url, '_blank' );
                    }
                    var privkey = chain_client.getPrivkey();
                    var pubkey = chain_client.getPubkey( privkey );
                    var address = tapscript.Address.fromScriptPubKey( [ 1, pubkey ], hedgehog.network );
                    hedgehog_workshop.btc_privkey = privkey;
                    hedgehog_workshop.btc_address = address;
                    $( '.btc_address' ).innerText = address;
                    showPage( 'wallet_page' );
                    stateLoop();
                }
                start();
            }
        </script>
        <div class="black-bg hidden" onclick="modalVanish();"></div>
        <div class="modal hidden"></div>
    </body>
</html>
